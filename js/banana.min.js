!function(e){e.fn.banana=function(t){var n=e.extend({url:"",urlUpload:"",level:[0],folder:"",target:"",tagTarget:"",tagTargetClass:"",thumbsFolder:"thumbs/",resetFolderOnStart:!0,allowDelete:!0,confirmDeletion:!1,multipleUpload:!0,allowUpload:!0,allowFolderCreate:!0,multiple:!1,selectedColor:!1,preview:!0,fileTypes:!1,i18n:{treeTitle:"Folders tree",newFolder:"New folder",clickToReload:"Click here to reload",search:"Search",urlEmpty:"Incomplete configuration, empty url."}},t),s={_settings:{},__settings:{action:"list",item:"",uploadDir:"",filesDb:new Array,resultsContainer:"",imageExtensions:["bmp","jpg","jpeg","gif","png"],selectedItems:[],tempScroll:!1,list:[]},_init:function(t){e("body").css("position","relative"),this._settings=t,this._resetSelectedItems(),this._appendContainer(),this._attachScroll(),this._lockDragOnDocument(),""!=t.url.trim()||this._displayError(this._settings.i18n.urlEmpty),s._triggerOutClick()},_resetSelectedItems:function(){this.__settings.selectedItems=[]},_attachWindowResize:function(t){e(window).resize(function(e){e.currentTarget.width>s._settings.responsiveMaxWidth&&s._move(t)})},_attachScroll:function(){var e=s._settings.container;this._settings.container.scroll(function(){e.scrollTop()>30?e.addClass("bnscrolled"):e.removeClass("bnscrolled")})},_createContainer:function(){var t=e("<div>",{"class":"bananaContainer bananimate "}),n=e("<div>",{id:"banana","class":"bananimate bye",html:t});e.extend(s._settings,{container:t}),t.bind("mousewheel DOMMouseScroll",function(t){var n=null;"mousewheel"==t.type?n=-1*t.originalEvent.wheelDelta:"DOMMouseScroll"==t.type&&(n=40*t.originalEvent.detail),n&&(t.preventDefault(),e(this).scrollTop(n+e(this).scrollTop()))});var i=0;return t.on("dragenter",function(t){s._settings.allowUpload&&(t.stopPropagation(),t.preventDefault(),i++,e(this).addClass("dragEnter"))}).on("dragover",function(e){s._settings.allowUpload&&(e.stopPropagation(),e.preventDefault())}).on("dragleave",function(t){s._settings.allowUpload&&(t.stopPropagation(),t.preventDefault(),i--,0==i&&e(this).removeClass("dragEnter"))}).on("drop",function(t){if(s._settings.allowUpload){e(this).removeClass("dragEnter"),t.preventDefault();var n=t.originalEvent.dataTransfer.files;s._dropFileUpload(n)}}),n},_appendContainer:function(){document.getElementById("banana")?s._settings.container=e("#banana .bananaContainer "):e("body").append(s._createContainer())},_getLoader:function(t){var n=e("<div>",{"class":"la-ball-clip-rotate-multiple la-dark "+(t?"":"la-3x"),style:"display:none"});return n.append(e("<div>")).append(e("<div>")),n.delay(250).fadeIn(200),n},_getData:function(t){"undefined"==typeof t&&(t=!0),s._resetContainer(),s.__settings.list=[],e.ajax({type:"POST",url:n.url,dataType:"JSON",data:{action:s.__settings.action,item:s.__settings.item,folder:s._settings.folder,fileTypes:s._settings.fileTypes},beforeSend:function(){s._settings.fileTypes&&(s._settings.fileTypes=s._settings.fileTypes.map(function(e){return e.toLowerCase()})),tempScroll=s._settings.container.scrollTop(),t&&s._settings.container.html("").append(s._getLoader(!1))},success:function(e,n,i){e.error?s._displayError(e.error):s._parseData(e,t),s._settings.container.scrollTop(tempScroll),s.__settings.action="list",s.__settings.item=""}}).fail(function(e){s._displayError("Error while loading data."),s._resetData()})},_resetData:function(e){s._settings.multiple&&e&&(s.__settings.selectedItems=[]),s.__settings.action="list",s.__settings.item="",e&&(s._settings.folder="")},_displayError:function(t){this._settings.container.empty(),this._settings.container.append(e("<div>",{"class":"error",html:"[*] "+t})),this._settings.container.append(e("<p>",{html:this._settings.i18n.clickToReload}).click(function(e){e.stopPropagation(),s._resetData(!0),s._getData()}))},_appendSearch:function(){return e("<div>",{"class":"searchDiv",html:e("<input>",{type:"text","class":"searchInput",placeholder:s._settings.i18n.search}).keyup(function(){var t=e(this).val();t.length>=3?s._search(t,s.__settings.filesDb):""==t.trim()?s._getTreeData():s.__settings.resultsContainer.html("")})})},_processTree:function(t){var n=s._settings.container;n.empty(),n.append(s._getTopBar(s._settings.i18n.treeTitle,!0));var i=e("<div>",{"class":"bnresults"});s.__settings.resultsContainer=i;var a=s._appendSearch();n.append(a),e(a).find("input")[0].focus();var l=e("<ul>",{"class":"bananaTree"});s.__settings.filesDb=[],s._treeLi(t.data,l,0),i.append(l),n.append(i)},_toDb:function(t){"object"==typeof t&&(s._areImagesFiltered()&&"object"==typeof t.pics&&e.each(t.pics,function(e,t){s.__settings.filesDb.push(t)}),"object"==typeof t.folders&&e.each(t.folders,function(e,t){s.__settings.filesDb.push(t)}),"object"==typeof t.others&&e.each(t.others,function(t,n){return s._settings.fileTypes&&s._settings.fileTypes.indexOf(t)<0?!0:void("object"==typeof n&&e.each(n,function(e,t){s.__settings.filesDb.push(t)}))}))},_search:function(e,t){var n=t.filter(function(t){return t.fullDir.toLowerCase().indexOf(e.toLowerCase())>=0?!0:void 0});s._processResults(n)},_processResults:function(t){var n=e("<ul>",{"class":"searchResults"});e.each(t,function(t,i){var a=e("<li>",{html:i.fileName,title:i.fullDir}).click(function(e){e.stopPropagation(),s._settings.preview?s._getPreviewScreen(i):s._select(i.fullDir)}),l=i.fileName.split(".");s.__settings.imageExtensions.indexOf(l[l.length-1].toLowerCase())>=0&&a.prepend(e("<span>",{"class":"searchPreview",style:"background-image:url('"+s._settings.thumbsFolder+i.fullDir+"')"})),n.append(a)}),s.__settings.resultsContainer.html(n)},_treeLi:function(t,n,i){e.each(t,function(t,a){i++;var l=e("<li>",{text:a.name,title:a.name,"class":a.depth>1?"":"root",style:"padding-left:"+15*i+"px"}).click(function(e){e.stopPropagation(),s._settings.folder=a.fullDir,s._getData(!0)});l.append(e("<span>",{html:a.filesCount>0?a.filesCount:"","class":"filesNumber"})),s._toDb(a.files),n.append(l),e.isEmptyObject(a.subfolders)||s._treeLi(a.subfolders,n,parseInt(i)),i--})},_getTreeData:function(){e.ajax({url:s._settings.url,type:"POST",data:{action:"tree",fileTypes:s._settings.fileTypes},dataType:"JSON",beforeSend:function(){e(s._settings.container).html(s._getLoader(!1))},success:function(e){e.error.length>0?s._displayError(e.error):s._processTree(e)}}).fail(function(){s._displayError("Error retrieving tree")})},search:function(e,t){for(var n in e)e.hasOwnProperty(n)&&(n==t?delete e[t]:"object"==typeof e[n]&&deleteRecursive(e[n],t))},_getTopBar:function(t,n){var i=this,a=e("<span>",{"class":"back"}).click(function(e){e.stopPropagation(),""!=s._settings.folder.trim()&&(i._settings.folder=s._settings.folder.substring(0,s._settings.folder.lastIndexOf("/"))),s._getData()}),l=e("<span>",{"class":"tree"}).click(function(e){e.stopPropagation(),s._getTreeData()}),r=e("<span>",{"class":"bnclose"}).click(function(e){e.stopPropagation(),s._hideBanana()}),o=e("<span>",{"class":"bnNewFolder"}).click(function(t){if(t.stopPropagation(),s._settings.container.removeClass("bneditmode"),e(this).hide(),e(s._settings.container).find(".newFolderForm").length<=0){var n=s._getFolderForm();s._settings.container.prepend(n),n.find("input").focus()}}),c=e("<span>",{"class":"edit "}).click(function(e){e.stopPropagation(),s._settings.container.toggleClass("bneditmode")}),p=e("<span>",{id:"currentFolder",html:t}),d=e("<span>",{"class":"bnConfirmSelection bananimate"}).click(function(e){e.stopPropagation(),s._select(s.__settings.selectedItems)});return e("<div>",{"class":"menu bananimate",html:s._settings.folder.indexOf("/")>=0&&""!=s._settings.folder.trim()||n?a:l}).append([""!=s._settings.folder.trim()?p:"",s._settings.multiple&&!n?d:"",r,n?"":c,n||!s._settings.allowFolderCreate?"":o])},_hideBanana:function(){var t=e("#banana");t.addClass("bye"),setTimeout(function(){s._settings.multiple&&(s.__settings.selectedItems=[]),s._resetContainer(!0),t.hide(),e("body").removeClass("bananaOpened")},300)},_getFolderForm:function(){var t=e("<input>",{type:"text",placeholder:this._settings.i18n.newFolder}).click(function(e){e.stopPropagation()}).keyup(function(t){var n=t.keyCode||t.which;return 13===n&&s._createFolder(e(this).val()),!1}),n=e("<div>",{"class":"newFolderForm"}).append(t).append(e("<button>",{html:"OK"}).click(function(e){e.preventDefault(),s._createFolder(t.val())}));return n},_createFolder:function(e){s.__settings.item=e,s.__settings.action="makedir",s._getData(!1)},_parseData:function(t,n){var i=s._settings.container;i.empty(),i.append(s._getTopBar(t.currentFolder,!1));var a=e("<ul>",{"class":"folders"});t.folders.length&&e.each(t.folders,function(t,n){a.append(e("<li>",{html:n.dirName,"class":"bananimate"}).click(function(e){e.stopPropagation(),s._settings.multiple&&(s.__settings.selectedItems=[]),s._resetData(),s._settings.folder=n.fullDir,s._getData()}).append(s._settings.allowDelete&&n.isEmpty?e("<div>",{"class":"bndeleteFolder bananimate"}).click(function(e){e.stopPropagation(),s.__settings.action="delete",s.__settings.item=n.fullDir,s._settings.confirmDeletion?confirm("Delete selected item")?s._getData(!1):s._resetData():s._getData(!1)}):""))}),i.append(a);var l=e("<input>",{type:"file","class":"bananaUpload"}).change(function(){s._fileUpload(this)});s._settings.multipleUpload&&l.attr("multiple","multiple");var r=e("<li>",{"class":"upload  bananimate"+(n?"minimized":""),id:"bananaUploadContainer",html:l}).append(e("<span>",{"class":"bananimate ",html:"+"})),o=e("<ul>",{"class":"pictures"});s._settings.allowUpload&&o.append(r),s._areImagesFiltered()&&t.pics.length&&e.each(t.pics,function(t,i){var a=parseInt(s.__settings.list.push(i))-1;o.append(e("<li>",{html:s._settings.allowDelete?e("<div>",{"class":"bndeleteImg bananimate"}).click(function(t){t.stopPropagation(),s.__settings.action="delete",s.__settings.item=i.fullDir,s._settings.confirmDeletion?(e(this).parent().addClass("deleted"),setTimeout(function(){confirm("Delete selected item")?(s._delMultipleItem(i),s._getData(!1)):s._resetData()},350)):(e(this).parent().addClass("deleted"),setTimeout(function(){s._delMultipleItem(i),s._getData(!1)},350))}):"",style:"background-image:url('"+s._settings.thumbsFolder+i.fullDir+"')","class":"bananimate "+(n?"minimized":"")+" "+i.fileType,title:i.fileName}).click(function(t){t.preventDefault(),t.stopPropagation();var n=e(t.currentTarget);s._settings.multiple?s._selectMultiple(i)?(n.addClass("selected"),s._settings.selectedColor&&n.css("background-color",s._settings.selectedColor)):(s._settings.selectedColor&&n.css("background-color",""),n.removeClass("selected")):s._settings.preview?s._getPreviewScreen(i,a):s._select(i.fullDir)}))}),i.append(o),"undefined"!=typeof t.others&&(i.append(e("<div>",{"class":"clearfix"})),e.each(t.others,function(t,n){if(s._settings.fileTypes&&s._settings.fileTypes.indexOf(t)<0)return!0;var a=e("<div>",{html:t,"class":"otherTitles"}),l=e("<ul>",{"class":"other"});e.each(n,function(i,a){var r=parseInt(s.__settings.list.push(a))-1,o=e("<li>",{"class":a.fileType+" "+t,html:e("<span>",{html:a.fileName.replace(/\|\-|\_/gi," "),"class":"otherName"}),title:a.fileName}).click(function(t){t.preventDefault(),t.stopPropagation();var i=e(t.currentTarget);s._settings.multiple?s._selectMultiple(a)?(i.addClass("selected"),s._settings.selectedColor&&i.css("color",s._settings.selectedColor)):(i.removeClass("selected"),i.css("color","")):s._settings.preview?s._getPreviewScreen(a,r):s._select(n.fullDir)});o.append(s._settings.allowDelete?e("<div>",{"class":"bndeleteFolder bananimate"}).click(function(e){e.stopPropagation(),s.__settings.action="delete",s.__settings.item=a.fullDir,s._settings.confirmDeletion?confirm("Delete selected item")?(s._delMultipleItem(a),s._getData(!1)):s._resetData():(s._delMultipleItem(a),s._getData(!1))}):""),l.append(o)}),i.append(a),i.append(l)})),i.append(e("<div>",{"class":"overflowShadow"})),lapse=n?30:0,s.__settings.tempScroll&&(s._settings.container.animate({scrollTop:s.__settings.tempScroll},150),s.__settings.tempScroll=!1),i.find("ul.pictures li").each(function(t,n){setTimeout(function(){e(n).removeClass("minimized")},(t+1)*lapse)})},_delMultipleItem:function(t){this.__settings.selectedItems=this.__settings.selectedItems.filter(function(e){return e.fullDir!=t.fullDir});var n=e(".bnConfirmSelection");this.__settings.selectedItems.length<=0&&n.removeClass("on")},_addMultipleItem:function(t){this.__settings.selectedItems.push(t);var n=e(".bnConfirmSelection");n.addClass("on")},_selectMultiple:function(e){var t=this.__settings.selectedItems.filter(function(t){return t.fullDir==e.fullDir});return t.length>0?(this._delMultipleItem(e),!1):(this._addMultipleItem(e),!0)},_move:function(t){window.innerWidth<=728&&e("body").addClass("bananaOpened");var n=0,i=0,a=e(t).offset(),l=s._settings.container.parent(),r=e(t);n=a.left+r.width()+2*parseInt(r.css("padding-left")),n+l.width()>=e(window).width()&&(n=a.left-l.width()),i=a.top-l.height()+r.height()+parseInt(r.css("padding-top")),0>=i&&(i=a.top+r.height()+parseInt(r.css("padding-top"))),l.css({left:n+"px",top:i+"px"})},_select:function(t){var n=s._settings.target;if("function"==typeof n?n(t):n instanceof jQuery?n.val(t):"string"==typeof n&&n.trim().length&&e(n).val(t),!s._settings.multiple){var i,a=s._settings.tagTarget;a instanceof jQuery?(i=s._createSrc(t))&&a.append():"string"==typeof a&&a.trim().length&&(i=s._createSrc(t))&&e(a).html(s._createSrc(t))}s._hideBanana()},_createSrc:function(t){var n=t.split(".");return s.__settings.imageExtensions.indexOf(n[n.length-1].toLowerCase())>=0?e("<img>",{src:t,"class":s._settings.tagTargetClass}):!1},_areImagesFiltered:function(){var t=!1;return!s._settings.fileTypes||s._settings.fileTypes.indexOf("image")>=0?!0:(e.each(s.__settings.imageExtensions,function(e,n){return s._settings.fileTypes.indexOf(n)>=0?(t=!0,!1):void 0}),t)},_lockDragOnDocument:function(){e(document).on("dragenter",function(e){e.stopPropagation(),e.preventDefault()}),e(document).on("dragover",function(e){e.stopPropagation(),e.preventDefault()}),e(document).on("drop",function(e){e.stopPropagation(),e.preventDefault()})},_triggerOutClick:function(){var t=e("#banana");e(document).click(function(n){return t.is(":visible")?void(e(n.target).closest("#banana").length||s._hideBanana()):!0})},_dropFileUpload:function(e){var t=new FormData;jQuery.each(e,function(e,n){t.append("file[]",n)}),s._ajaxFiles(t)},_fileUpload:function(e){jQuery.each(jQuery(e)[0].files,function(e,t){var n=new FormData;n.append("file[]",t),s._ajaxFiles(n)})},_ajaxFiles:function(t){s._settings.fileTypes&&e.each(s._settings.fileTypes,function(e,n){t.append("fileTypes[]",n)}),t.append("action","upload"),t.append("folder",s._settings.folder),jQuery.ajax({url:s._settings.urlUpload,data:t,cache:!1,async:!0,contentType:!1,processData:!1,type:"POST",beforeSend:function(){e("#bananaUploadContainer").html(s._getLoader(!0)).append(e("<span>",{id:"bananaProgress"}))},success:function(e){console.warn(e),s._getData(!1)},xhr:function(){var t=e("#bananaProgress"),n=!1,s=e.ajaxSettings.xhr();return s.upload&&s.upload.addEventListener("progress",function(e){var s=0,i=e.loaded||e.position,a=e.total;e.lengthComputable&&(s=Math.ceil(i/a*100),s>=95&&!n?(n=!0,t.hide()):95>s&&t.css({width:s+"%"}))},!1),s}}).fail(function(e){console.error(e)})},_resetContainer:function(t){t&&(s.__settings.tempScroll=!1,console.info("Resetting scroll")),s._settings.container.removeClass("bnpreview").css("background-image",""),e(document).unbind("keydown")},_bindArrowKeys:function(t){var n=s.__settings.list;(n[t-1]||n[t+1])&&e(document).unbind("keydown").bind("keydown",function(e){switch(e.which){case 37:n[t-1]&&s._getPreviewScreen(n[t-1],t-1);break;case 38:case 40:s._resetContainer(),s._getData(!1);break;case 39:n[t+1]&&s._getPreviewScreen(n[t+1],t+1);break;default:return}e.preventDefault()})},_getPreviewScreen:function(t,n){s._resetContainer(!1),n>=0&&s._bindArrowKeys(n),s.__settings.tempScroll=s._settings.container.scrollTop(),bg=!1,s.__settings.imageExtensions.indexOf(t.fullDir.substring(t.fullDir.lastIndexOf(".")+1).toLowerCase())>=0&&(bg=!0),__settings.list[n+1]&&s.__settings.imageExtensions.indexOf(s,__settings.list[n+1].fullDir.substring(s,__settings.list[n+1].fullDir.lastIndexOf(".")+1).toLowerCase())>=0;var i=bg?e("<img>",{"class":"bn_previewImage",src:bg?t.fullDir:""}):e("<div>",{"class":"bn_previewFile",html:[e("<div>",{"class":"extension",html:t.fullDir.substring(t.fullDir.lastIndexOf(".")+1)}),t.fileName]}),a=e("<span>",{"class":"bn_btnok",click:function(){s._select(t.fullDir)}}),l=e("<span>",{"class":"bn_btnko",click:function(){s._resetContainer(),s._getData(!1)}}),r=e("<div>",{"class":"bn_btn_cont",html:[a,l]}),o=e("<div>",{id:"bn_previewContainer",html:[].concat(e("<div>",{"class":"bn_previewwrapper",html:i}),r,e("<div>",{"class":"bn_properties"}))});s._settings.container.html(o).addClass("bnpreview"),bg&&s._settings.container.css({"background-image":"url('"+t.fullDir+"')"}),this._getFileInfo(t),s._settings.container.scrollTop(0)},_getFileInfo:function(t){var i=[],a=e(".bn_properties"),l=s._getLoader();e.ajax({type:"POST",url:n.url,dataType:"JSON",data:{action:"fileinfo",file:t.fullDir,fileTypes:s._settings.fileTypes},beforeSend:function(){},success:function(t,n,r){l.hide(),t.error?s._displayError(t.error):(e.each(t,function(t,n){i.push(e("<div>",{"class":"bn_property",html:[e("<span>",{"class":"bn_prop_title",html:s._settings.i18n[t]?s._settings.i18n[t]:t}),e("<span>",{"class":"bn_prop_value",html:n})]}))}),a.append(i))}}).fail(function(e){s._displayError("Error while loading data."),s._resetData()})}};return s._init(n),this.each(function(){e(this).css({}).click(function(e){e.stopPropagation(),e.preventDefault(),s._settings.resetFolderOnStart?s._settings.folder="":s._settings.container.scrollTop(0),s._getData(),s._move(this),s._attachWindowResize(this),s._settings.container.parent().show(),setTimeout(function(){s._settings.container.parent().removeClass("bye")},100)})})}}(jQuery);